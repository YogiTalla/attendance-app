<!DOCTYPE html>
<html>
<head>
  <title>Vss Site Attendance</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>Site Attendance</h2>

  <div id="login">
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
  </div>

  <div id="attendance" style="display:none;">
    <button onclick="markAttendance()">Mark Attendance</button>
  </div>

<script>
const SUPABASE_URL = "https://xxnahyuyhswihggeordi.supabase.co";
const SUPABASE_KEY = "sb_publishable__etrPjnloOrjpXTNKj2t4g_zlUnHzHB";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });

  if (error) {
    alert("Login failed");
  } else {
    document.getElementById("login").style.display = "none";
    document.getElementById("attendance").style.display = "block";
  }
}


async function markAttendance() {

  const video = document.createElement("video");
  const canvas = document.createElement("canvas");

  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  await video.play();

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  stream.getTracks().forEach(track => track.stop());

  const blob = await new Promise(resolve => 
    canvas.toBlob(resolve, "image/jpeg")
  );

  const fileName = `photo_${Date.now()}.jpg`;

  const { data: uploadData, error: uploadError } =
    await supabase.storage
      .from("attendance-photos")
      .upload(fileName, blob);

  if (uploadError) {
    alert("Photo upload failed");
    return;
  }

  const { data: publicUrl } =
    supabase.storage
      .from("attendance-photos")
      .getPublicUrl(fileName);

  navigator.geolocation.getCurrentPosition(async (position) => {

    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;

    const user = await supabase.auth.getUser();
    const userId = user.data.user.id;

    const { error } = await supabase.from("attendance").insert([
      {
        user_id: userId,
        latitude: latitude,
        longitude: longitude,
        photo_url: publicUrl.publicUrl
      }
    ]);

    if (error) {
      alert("Error saving attendance");
    } else {
      alert("Attendance Marked with Photo");
    }

  });

}
</script>

</body>
</html>
